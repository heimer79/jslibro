<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
"http://www.w3.org/TR/html4/loose.dtd">

<!--
NOMBRE DEL SCRIPT : JSON_05.htm
AUTOR : Christian VIGOUROUX
FECHA DE CREACIÓN : 15/10/2018
FECHA ÚLTIMA MODIFICACIÓN : 15/10/2018
OBJETIVO : Utilización de JSON
-->

<!-- Inicio script HTML -->
<html>

	<!-- Inicio encabezado script HTML -->
	<head>

		<!-- Etiqueta meta -->
		<meta http-equiv="Content-Type"
		content="text/html; charset=utf-8" />

		<!-- Título del script HTML -->
		<title>JSON_05</title>

		<!-- Inicio script JavaScript -->
		<script type="text/javascript">
		
			/* Función que comprueba si se ha seleccionado una opción
			en la lista desplegable */
			function controlarOpcionLista(lista, mensajeAlerta) {
				if (lista.value == "CODIGO") {
					/* Visualización de un mensaje de alerta */
					alert(mensajeAlerta);
					/* Foco en el campo con error */
					lista.focus();
					/* Valor de retorno */
					return false;
				} else {
					/* Llamada a la función ajaxJSON */
					ajaxJSON();
					/* Valor de retorno */
					return true;
				}
			}

			/* Función ajaxJSON */
			function ajaxJSON() {

				/* Asociación de la variable resultado a la capa
				de visualización capaResultado */
				var resultado = document.getElementoById("capaResultado");

				/* Inicialización de un objeto de tipo XMLHttpRequest
				/* Nota del autor: XMLHttpRequest es un objeto ActiveX
				o JavaScript que permite obtener datos
				en formato XML, JSON, pero también HTML o incluso texto
				simple con ayuda de consultas HTTP. */
				if (window.XMLHttpRequest) {
					// Código para IE7+, Firefox, Chrome, Opera, Safari
					httpRequest = new XMLHttpRequest();
				} else {
					// Código para IE6, IE5
					httpRequest = new ActiveXObject("Microsoft.XMLHTTP");
				}

				/* Apertura del archivo coches.json
				con el script PHP servidorJSON.php*/
				/* true : modo asíncrono -> el flujo debe estar disponible
				completamente antes de su tratamiento */
				httpRequest.open("POST", "servidorJSON.php", true);

				/* Definición del tipo de flujo al servidor */
				httpRequest.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
				/* NB1 : application/x-www-form-urlencoded
				es el valor a retener para el envío de argumentos
				desde un formulario HTML
				(lista desplegable en nuestro caso) */
				/* NB2 : Los valores se codifican */

				/* Tratamiento realizado tan pronto como el flujo esté disponible */
				httpRequest.onreadystatechange = function() {
					/* Verifica si la consulta está terminada y verifica estado OK */
					if (httpRequest.readyState == 4 && httpRequest.estado == 200) {
						/* Visualización de control */
						alert("responseText : " + httpRequest.responseText);
						/* Conversión del flujo JSON en objetos Javascript */
						var datosJSON = JSON.parse(httpRequest.responseText);
						/* Inicialización de la variable resultado */
						resultado.innerHTML = "";
						/* Recorrido de los objetos Javascript */
						for (var objeto in datosJSON) {
							/* Concatenación del resultado */
							resultado.innerHTML += "Código coche : " + datosJSON[objeto].codigo_coche + "<br />";

							resultado.innerHTML += "Nombre : " + datosJSON[objeto].nombre_coche + "<br />";

							resultado.innerHTML += "Velocidad máxima : " + datosJSON[objeto].velocidad_maxima_coche + "<hr />";
						}
					}
				}
				/* Enviar datos a través de la consulta
				XMLHttpRequest al script PHP servidorJSON.php */
				var argumento = 'code=';
				argumento += document.getElementoById('lista').value;
				// alert("Argumento : " + argumento);
				httpRequest.send(argumento);

				/* Mensaje que se muestra esperando la operación */
				/* (recuperación de los datos
				desde la tabla MySQL coches) */
				resultado.innerHTML = "A la espera del tratamiento JSON ...";

			}

		</script>

	</head>

	<!-- Inicio sección body del script HTML -->
	<body>

		<!-- Título de la operación -->
		<h1>Ediciones ENI - JavaScript - JSON_05</h1>

		<!-- Inicio script JavaScript -->
		<script type="text/javascript">
			
			/* Visualización del nombre del script */
			alert("JSON_05");

		</script>

		<!-- Formulario de introducción de datos del código del coche a preguntar -->
		<form name="formulario">
			<!-- Lista desplegable de la selección -->
			Código del coche :
			<select
			id="lista"
			onchange="controlarOpcionLista(document.getElementoById('lista'), 'Por favor, seleccione un código')">
				<option	value="CODIGO" selected> Código coche </option>
				<option value="V001"> V001 </option>
				<option value="V002"> V002 </option>
				<option	value="V003"> V003 </option>
			</select>
		</form>

		<!-- Capa de visualización del resultado -->
		<div id="capaResultado"></div>

	</body>

</html>